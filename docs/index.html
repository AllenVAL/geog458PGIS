<!DOCTYPE html>
<html>
<head>
<title>UW LGBTQ+ Community Map</title>
<script src="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.css" rel="stylesheet"/>
<style>
body{margin:0;padding:0}
#map{position:absolute;top:0;bottom:0;width:100%}
#info{
position:absolute;
top:0;
left:0;
width:320px;
margin:10px;
padding:10px;
background:#fff;
border-radius:5px;
font-family:Arial;
font-size:12px;
z-index:1
}
#name,#content,#identity{width:100%;margin-bottom:8px}
</style>
</head>

<body>

<div id="map"></div>

<div id="info">
<h3>UW LGBTQ+ Community Map</h3>
<p>Click anywhere to share LGBTQ+ friendly places, memories, or experiences at UW.</p>
</div>

<script>

let popup=null;

let geojson={
type:'FeatureCollection',
features:[]
};

let map=new maplibregl.Map({
container:'map',
style:'https://api.maptiler.com/maps/streets-v2/style.json?key=Cusoe5zmfmn26glFoeoe',
center:[-122.305,47.655],
zoom:13
});

window.addEventListener("load",async function(){

let response=await fetch('geog458pgis-2928568466c7.herokuapp.com/api/get-record');

let data=await response.json();

for(let i=0;i<data.rows.length;i++){

geojson.features.push({
type:'Feature',
properties:{
contributor:data.rows[i].contributor,
content:data.rows[i].content,
identity:data.rows[i].identity
},
geometry:{
type:'Point',
coordinates:[data.rows[i].lng,data.rows[i].lat]
}
});

}

map.getSource('places').setData(geojson);

});

map.on("load",function(){

map.addSource('places',{
type:'geojson',
data:geojson
});

map.addLayer({
id:'placesLayer',
type:'circle',
source:'places',
paint:{
'circle-radius':7,
'circle-color':[
'interpolate',
['linear'],
['get','id'],
0,'#ff0000',
1,'#ff8000',
2,'#ffff00',
3,'#00ff00',
4,'#0000ff',
5,'#8000ff'
]
}
});

});

map.on('mouseenter','placesLayer',function(e){

map.getCanvas().style.cursor='pointer';

let c=e.features[0].properties.contributor;
let t=e.features[0].properties.content;
let i=e.features[0].properties.identity;

popup=new maplibregl.Popup()
.setLngLat(e.features[0].geometry.coordinates)
.setHTML("<b>"+c+"</b><br>"+i+"<br>"+t)
.addTo(map);

});

map.on('mouseleave','placesLayer',function(){
map.getCanvas().style.cursor='';
popup.remove();
});

map.on('click',function(e){

if(popup)popup.remove();

let html=`
<input id="name" placeholder="name">
<input id="identity" placeholder="identity (optional)">
<input id="content" placeholder="message">
<button id="submit">submit</button>
`;

popup=new maplibregl.Popup({closeOnClick:false})
.setLngLat(e.lngLat)
.setHTML(html)
.addTo(map);

document.getElementById('submit').onclick=submitNewRecord;

});

async function submitNewRecord(){

let contributor=document.getElementById('name').value;
let content=document.getElementById('content').value;
let identity=document.getElementById('identity').value;
let lngLat=popup.getLngLat();

let form=new URLSearchParams();

form.append('contributor',contributor);
form.append('content',content);
form.append('identity',identity);
form.append('lng',lngLat.lng);
form.append('lat',lngLat.lat);

await fetch('https://geog458pgis-2928568466c7.herokuapp.com/api/add-record',{
method:'POST',
body:form
});

popup.remove();

geojson.features.push({
type:'Feature',
properties:{contributor,content,identity},
geometry:{
type:'Point',
coordinates:[lngLat.lng,lngLat.lat]
}
});

map.getSource('places').setData(geojson);

}

</script>

</body>
</html>
